{% extends 'base.html' %}
{% block content %}
<h2>{{ quiz.name }}</h2>

<button id="startQuizBtn">Start Quiz</button>

<div id="quizContainer" style="display: none;">
  <h3 id="questionText"></h3>
  <input type="text" id="answerInput" placeholder="Type your answer here..." />
  <button id="submitAnswerBtn">Submit</button>

  <div id="timer">Time left: <span>--</span> seconds</div>
</div>

<div id="resultsContainer" style="display: none;">
  <h3>Results</h3>
  <p id="finalMessage"></p>
</div>

<script>
  let quizSocket = null;
  let currentQuestionId = null;
  let timeLeft = 0;
  let timerInterval = null;

  const startQuizBtn = document.getElementById("startQuizBtn");
  const quizContainer = document.getElementById("quizContainer");
  const questionText = document.getElementById("questionText");
  const answerInput = document.getElementById("answerInput");
  const submitAnswerBtn = document.getElementById("submitAnswerBtn");
  const timerElement = document.getElementById("timer").querySelector("span");
  const resultsContainer = document.getElementById("resultsContainer");
  const finalMessage = document.getElementById("finalMessage");

  // On page load, create the WebSocket connection
  document.addEventListener("DOMContentLoaded", () => {
    const quizId = "{{ quiz.id }}";
    // For production with HTTPS, use wss://
    quizSocket = new WebSocket(`ws://${window.location.host}/ws/quiz/${quizId}/`);

    quizSocket.onmessage = function(e) {
      const data = JSON.parse(e.data);
      if (data.action === "next_question") {
        showQuestion(data);
      } else if (data.action === "quiz_finished") {
        showResults(data);
      } else if (data.message) {
        console.log("Server says:", data.message);
      }
    };

    quizSocket.onopen = function(e) {
      console.log("WebSocket connected.");
    };

    quizSocket.onclose = function(e) {
      console.log("WebSocket closed unexpectedly.");
    };
  });

  startQuizBtn.addEventListener("click", () => {
    // Start the quiz by sending an action
    quizSocket.send(JSON.stringify({ action: "start_quiz" }));
    startQuizBtn.style.display = "none";
    quizContainer.style.display = "block";
  });

  submitAnswerBtn.addEventListener("click", () => {
    const userAnswer = answerInput.value;
    quizSocket.send(JSON.stringify({
      action: "submit_answer",
      question_id: currentQuestionId,
      answer_text: userAnswer
    }));
    answerInput.value = "";
    stopTimer();
  });

  function showQuestion(data) {
    currentQuestionId = data.question_id;
    questionText.textContent = data.question_text;
    timeLeft = data.time_limit;
    timerElement.textContent = timeLeft;
    startTimer();
  }

  function startTimer() {
    stopTimer(); // clear any existing interval
    timerInterval = setInterval(() => {
      timeLeft--;
      timerElement.textContent = timeLeft;
      if (timeLeft <= 0) {
        stopTimer();
        // Automatically submit empty or partial answer if time runs out
        quizSocket.send(JSON.stringify({
          action: "submit_answer",
          question_id: currentQuestionId,
          answer_text: answerInput.value
        }));
        answerInput.value = "";
      }
    }, 1000);
  }

  function stopTimer() {
    if (timerInterval) {
      clearInterval(timerInterval);
      timerInterval = null;
    }
  }

  function showResults(data) {
    quizContainer.style.display = "none";
    resultsContainer.style.display = "block";
    finalMessage.textContent = data.message + " Score: " + data.score;
  }
</script>
{% endblock %}
